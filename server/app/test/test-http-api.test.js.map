{"version":3,"sources":["test/test-http-api.test.js"],"names":["request","require","logger","nconf","describe","apiServer","before","done","defaults","port","hilbert_cli_path","test","scriptConcurrency","max_log_length","log_directory","log_level","mkls_poll_delay","mkls_cmd","long_poll_timeout","db_path","testBackend","addStation","id","name","type","default_app","possible_apps","stationManager","getHilbertCLIConnector","getMKLivestatusConnector","init","then","httpAPIServer","getServer","it","get","set","expect","post","send","ids","app"],"mappings":"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","file":"test/test-http-api.test.js","sourcesContent":["import StationManager from '../lib/station-manager';\nimport HttpAPIServer from '../lib/http-api-server';\nimport TestBackend from '../lib/test-backend';\n\nconst request = require('supertest');\nconst logger = require('winston');\nconst nconf = require('nconf');\n\ndescribe('HTTP API', () => {\n  let apiServer = null;\n\n  before((done) => {\n    nconf.defaults({\n      port: '3000',\n      hilbert_cli_path: '../work/dockapp',\n      test: true,\n      scriptConcurrency: 20,\n      max_log_length: 100,\n      log_directory: './log',\n      log_level: 'info', // error, warn, info, verbose, debug, silly\n      mkls_poll_delay: 1000,\n      mkls_cmd: 'nc localhost 6557',\n      long_poll_timeout: 0,\n      db_path: '',\n    });\n\n    const testBackend = new TestBackend(nconf, logger);\n    testBackend.addStation({\n      id: 'station_a',\n      name: 'Station A',\n      type: 'type_a',\n      default_app: 'app_a',\n      possible_apps: ['app_a', 'app_b', 'app_c'],\n    });\n    const stationManager = new StationManager(\n      nconf,\n      logger,\n      testBackend.getHilbertCLIConnector(),\n      testBackend.getMKLivestatusConnector()\n    );\n\n    stationManager.init().then(() => {\n      const httpAPIServer = new HttpAPIServer(stationManager, nconf, logger);\n      httpAPIServer.init().then(() => {\n        apiServer = httpAPIServer.getServer();\n        done();\n      });\n    });\n  });\n\n  describe('GET /stations', () => {\n    it('responds with JSON', (done) => {\n      request(apiServer)\n        .get('/stations')\n        .set('Accept', 'application/json')\n        .expect('Content-Type', /json/)\n        .expect(200, done);\n    });\n  });\n\n  describe('POST /stations/start', () => {\n    it('fails with no arguments', (done) => {\n      request(apiServer)\n        .post('/stations/start')\n        .set('Accept', 'application/json')\n        .expect(400, done);\n    });\n\n    it('responds with JSON', (done) => {\n      request(apiServer)\n        .post('/stations/start')\n        .send({ ids: 'station_interactive_1' })\n        .set('Accept', 'application/json')\n        .expect('Content-Type', /json/)\n        .expect(200, done);\n    });\n  });\n\n  describe('POST /stations/stop', () => {\n    it('fails with no arguments', (done) => {\n      request(apiServer)\n        .post('/stations/start')\n        .set('Accept', 'application/json')\n        .expect(400, done);\n    });\n\n    it('responds with JSON', (done) => {\n      request(apiServer)\n        .post('/stations/stop')\n        .send({ ids: 'station_interactive_1' })\n        .set('Accept', 'application/json')\n        .expect('Content-Type', /json/)\n        .expect(200, done);\n    });\n  });\n\n  describe('POST /stations/change_app', () => {\n    it('fails with no arguments', (done) => {\n      request(apiServer)\n        .post('/stations/start')\n        .set('Accept', 'application/json')\n        .expect(400, done);\n    });\n\n    it('responds with JSON', (done) => {\n      request(apiServer)\n        .post('/stations/change_app')\n        .send({ ids: 'station_a' })\n        .send({ app: 'app_b' })\n        .set('Accept', 'application/json')\n        .expect('Content-Type', /json/)\n        .expect(200, done);\n    });\n  });\n\n  describe('GET /station/:id/output', () => {\n    it('fails if the station does not exist', (done) => {\n      request(apiServer)\n        .get('/station/station_x/output')\n        .set('Accept', 'application/json')\n        .expect(404, done);\n    });\n\n    it('responds with JSON', (done) => {\n      request(apiServer)\n        .get('/station/station_a/output')\n        .set('Accept', 'application/json')\n        .expect('Content-Type', /json/)\n        .expect(200, done);\n    });\n  });\n\n  describe('GET /server/output', () => {\n    it('responds with JSON', (done) => {\n      request(apiServer)\n        .get('/server/output')\n        .set('Accept', 'application/json')\n        .expect('Content-Type', /json/)\n        .expect(200, done);\n    });\n  });\n\n  describe('GET /server/mklivestatus', () => {\n    it('responds with JSON', (done) => {\n      request(apiServer)\n        .get('/server/mklivestatus')\n        .set('Accept', 'application/json')\n        .expect('Content-Type', /json/)\n        .expect(200, done);\n    });\n  });\n\n  describe('GET /notifications', () => {\n    it('responds with JSON', (done) => {\n      request(apiServer)\n        .get('/notifications')\n        .set('Accept', 'application/json')\n        .expect('Content-Type', /json/)\n        .expect(200, done);\n    });\n  });\n});\n"],"sourceRoot":"/source/"}